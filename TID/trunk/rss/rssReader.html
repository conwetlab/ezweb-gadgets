<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
  <title>RSS Reader</title>
  <script type="text/javascript" language="javascript" src="http://www.prototypejs.org/assets/2007/11/6/prototype.js"></script>
  <script type="text/javascript" language="javascript" src="/ezweb/js/EzWebAPI/EzWebAPI.js"></script>
  <script type="text/javascript" language="javascript">
	var lastShow = "item_0";
	var rssUrl = EzWebAPI.createRGadgetVariable("rssUrl", _Handler);
	var rssPref = EzWebAPI.createRGadgetVariable("rssPref", _Handler);
	var URL = rssPref.get();
    if (URL != null)
    {
	   EzWebAPI.send_get (URL, this, processRSS, failedRSS);
    }
	
	//shows the RSS content in the browser
	function showRSS(RSS) {
		var item_html;

		//default values for html tags used
		var imageTag = "<img class='chan_image'";
		var startItemTag = "<li class='item'>";
		var startTitle = "<div class='item_title'>";
		var startLink = "<div class='item_link'>";
		var startDescription = "<div class='item_description'>";
		var endTag = "</div>";

		//populate channel data
		var properties = new Array("title","link","description","pubDate","copyright");
		for (var i=0; i<properties.length; i++)	{
			document.getElementById('chan_' + properties[i]).innerHTML = '';
			curProp = RSS[properties[i]];
			if (curProp != null)
				document.getElementById('chan_' + properties[i]).innerHTML = curProp;
			if (properties[i] == 'link')
			{
				document.getElementById("chan_link").href = curProp;
				document.getElementById("chan_link").target = '_blank';
			}
		}

		//show the image
		document.getElementById("chan_image_link").innerHTML = "";
		if (RSS.image.url != null)
		{
			document.getElementById("chan_image_link").href = RSS.image.link;
			document.getElementById("chan_image_link").innerHTML = imageTag
				+" alt='"+RSS.image.description
				+"' width='"+RSS.image.width
				+"' height='"+RSS.image.height
				+"' src='"+RSS.image.url
				+"' "+"/>";
		}

		//populate the items
		document.getElementById("chan_items").innerHTML = "<ul>";
		for (var i=0; i<RSS.items.length; i++)
		{
			item_html = startItemTag;
			item_html += (RSS.items[i].title == null) ? "" : startTitle + "<a href=\"javascript:toggle('item_" + i + "');\">" + RSS.items[i].title + "</a>" + endTag;
			item_html += "<div id='item_" + i + "' class='item_content' style='display:none;'>";
			item_html += (RSS.items[i].link == null) ? "" : startLink + "<a href='" + RSS.items[i].link +"' target='_black'>see more...</a>" + endTag;
			item_html += (RSS.items[i].description == null) ? "" : startDescription + RSS.items[i].description + endTag;
			item_html += endTag;
			item_html += "</li>";
			document.getElementById("chan_items").innerHTML += item_html;
		}
		document.getElementById("chan_items").innerHTML += "</ul>";
		
		var descriptions = document.getElementsByClassName("item_description");
		for (var i=0; i<descriptions.length; i++)
		{
		     var links = descriptions[i].getElementsByTagName("a");
		       for (var j=0; j<links.length; j++)
		       {
		             links[j].target="_blank";
		        }
		}

		        
		//we're done
		return true;
	}


	//OBJECTS

	//objects inside the RSS2Item object
	function RSS2Enclosure(encElement)
	{
		if (encElement == null)
		{
			this.url = null;
			this.length = null;
			this.type = null;
		}
		else
		{
			this.url = encElement.getAttribute("url");
			this.length = encElement.getAttribute("length");
			this.type = encElement.getAttribute("type");
		}
	}

	function RSS2Guid(guidElement)
	{
		if (guidElement == null)
		{
			this.isPermaLink = null;
			this.value = null;
		}
		else
		{
			this.isPermaLink = guidElement.getAttribute("isPermaLink");
			this.value = guidElement.childNodes[0].nodeValue;
		}
	}

	function RSS2Source(souElement)
	{
		if (souElement == null)
		{
			this.url = null;
			this.value = null;
		}
		else
		{
			this.url = souElement.getAttribute("url");
			this.value = souElement.childNodes[0].nodeValue;
		}
	}

	//object containing the RSS 2.0 item
	function RSS2Item(itemxml)
	{
		//required
		this.title;
		this.link;
		this.description;

		//optional vars
		this.author;
		this.comments;
		this.pubDate;

		//optional objects
		this.category;
		this.enclosure;
		this.guid;
		this.source;

		var properties = new Array("title", "link", "description", "author", "comments", "pubDate");
		var tmpElement = null;
		for (var i=0; i<properties.length; i++)
		{
			tmpElement = itemxml.getElementsByTagName(properties[i])[0];
			if (tmpElement != null)
				this[properties[i]] = tmpElement.childNodes[0].nodeValue;
		}

		this.category = new RSS2Category(itemxml.getElementsByTagName("category")[0]);
		this.enclosure = new RSS2Enclosure(itemxml.getElementsByTagName("enclosure")[0]);
		this.guid = new RSS2Guid(itemxml.getElementsByTagName("guid")[0]);
		this.source = new RSS2Source(itemxml.getElementsByTagName("source")[0]);
	}

	//objects inside the RSS2Channel object
	function RSS2Category(catElement)
	{
		if (catElement == null)
		{
			this.domain = null;
			this.value = null;
		}
		else
		{
			this.domain = catElement.getAttribute("domain");
			this.value = catElement.childNodes[0].nodeValue;
		}
	}

	//object containing RSS image tag info
	function RSS2Image(imgElement) {
		if (imgElement == null) {
			this.url = null;
			this.link = null;
			this.width = null;
			this.height = null;
			this.description = null;
		} else {
			imgAttribs = new Array("url","title","link","width","height","description");
			var tmpElement = null;
			for (var i=0; i<imgAttribs.length; i++) {
				tmpElement = imgElement.getElementsByTagName(imgAttribs[i])[0];
				if (tmpElement != null)
					this[imgAttribs[i]] = tmpElement.textContent;
			}
		}
	}

	//object containing the parsed RSS 2.0 channel
	function RSS2Channel(rssxml)
	{
		//required
		this.title;
		this.link;
		this.description;

		//array of RSS2Item objects
		this.items = new Array();

		//optional vars
		this.language;
		this.copyright;
		this.managingEditor;
		this.webMaster;
		this.pubDate;
		this.lastBuildDate;
		this.generator;
		this.docs;
		this.ttl;
		this.rating;

		//optional objects
		this.category;
		this.image;

		var chanElement = rssxml.getElementsByTagName("channel")[0];
		var itemElements = rssxml.getElementsByTagName("item");

		for (var i=0; i<itemElements.length; i++)
		{
			Item = new RSS2Item(itemElements[i]);
			this.items.push(Item);
			//chanElement.removeChild(itemElements[i]);
		}

		var properties = new Array("title", "link", "description", "language", "copyright", "managingEditor", "webMaster", "pubDate", "lastBuildDate", "generator", "docs", "ttl", "rating");
		var tmpElement = null;
		for (var i=0; i<properties.length; i++)
		{
			tmpElement = chanElement.getElementsByTagName(properties[i])[0];
			if (tmpElement!= null)
				eval("this."+properties[i]+"=tmpElement.childNodes[0].nodeValue");
		}

		this.category = new RSS2Category(chanElement.getElementsByTagName("category")[0]);
		this.image = new RSS2Image(chanElement.getElementsByTagName("image")[0]);
	}
	
	
		function processRSS (response)
		{
			var rss = new RSS2Channel (response.responseXML);
			showRSS(rss);
		}
		function failedRSS (response)
		{
			$('chan_title').innerHTML = "Error al obtener el feed";
		}	
		function _Handler(value)
		{
			$('chan_title').innerHTML = "Esperando RSS...";
			$('chan_link').innerHTML = '';
			$('chan_description').innerHTML = '';
			$('chan_image_link').innerHTML = '';
			$('chan_items').innerHTML = '';
			$('chan_pubDate').innerHTML = '';
			$('chan_copyright').innerHTML = '';
			lastShow = "item_0";
			if (value != null)
			{
				EzWebAPI.send_get (value, this, processRSS, failedRSS);
			}
		}

		function show(id) 
		{
			document.getElementById(id).style.display = "block";
		}

		function hide(id) 
		{
			if (id != "") document.getElementById(id).style.display = "none";
		}

		function toggle(id)
		{
			if (document.getElementById(id).style.display == "none")
			{
				hide(lastShow);
				show(id);
				lastShow = id;
			}
			else hide(id);
		}
    </script>
	<style type="text/css">
		body {	
			background-color: #ffffcc;
			font-family:"Trebuchet MS","Bitstream Vera Sans",Verdana,Helvetica,sans-serif;
			font-size:12px;
		}
		
		a {
			color:blue;
			text-decoration:none;
		}
		
		a:hover {
			text-decoration:underline;
		}
		
		.item_content {
			background-color: #ffffaa
		}
		
		#chan {
			margin-top: 10px;
		}
		
		#chan_title {
			font-size:20px;
			font-weight:bold;
		}
		
		li {
			margin-left:15px;
		}
		
		.item_title a {
			color:#006633;
		}
		
		#chan_items { 
			margin: 10px; 
		}
		
		.item { 
			margin-bottom: 2px; 
		}

		#chan_pubDate {
			font-size:11px;
		}
		#chan_image_link {
			float: right;
		}
		img {
			border: 0px;
		}
	</style>
</head>
<body>
    <div id="chan">
	<a id="chan_image_link" href="" target="_blank"></a>
        <div id="chan_title">Esperando RSS...</div>
        <a id="chan_link" href=""></a>
        <div id="chan_description"></div>
        <a id="chan_image_link" href=""></a>
        <div id="chan_items"></div>
        <div id="chan_pubDate"></div>
        <div id="chan_copyright"></div>
    </div>
</body>
</html>
